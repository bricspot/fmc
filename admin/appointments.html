<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments | Focus Clinical Admin</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>

<body class="admin-body">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <img src="../assets/images/admin-logo.png" alt="Focus Clinical" class="sidebar-logo">
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </a>
            <a href="appointments.html" class="nav-item active">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </a>
            <a href="contacts.html" class="nav-item">
                <i class="fas fa-envelope"></i>
                <span>Contact Messages</span>
            </a>
            <a href="settings.html" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="../index.html" class="nav-item">
                <i class="fas fa-globe"></i>
                <span>View Website</span>
            </a>
            <button class="nav-item logout-btn" onclick="adminLogout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Appointments</h1>
            </div>
            <div class="topbar-right">
                <div class="admin-user">
                    <i class="fas fa-user-circle"></i>
                    <span>helpdesk@focusdiagnostics.co.ke</span>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <!-- Page Header -->
            <div class="page-header">
                <h2>All Appointment Requests</h2>
                <div class="header-actions">
                    <button class="btn btn-export" onclick="exportAppointmentsCSV()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-export" onclick="exportAppointmentsPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>

            <!-- Appointments Table -->
            <div class="dashboard-card">
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="appointmentsTable">
                        <thead>
                            <tr>
                                <th>Patient Name</th>
                                <th>Phone</th>
                                <th>Service</th>
                                <th>Branch</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <p class="empty-state" id="noAppointments" style="display: none;">
                        <i class="fas fa-calendar-times"></i><br>
                        No appointments found
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- View Modal -->
    <div class="modal-overlay" id="viewModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Appointment Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="appointmentDetails">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" id="confirmBtn" onclick="confirmAppointment()">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
        requireAuth();

        let currentAppointmentId = null;

        function loadAppointments() {
            const appointments = getAppointments().reverse();
            const tbody = document.querySelector('#appointmentsTable tbody');

            if (appointments.length === 0) {
                document.getElementById('noAppointments').style.display = 'block';
                document.getElementById('appointmentsTable').style.display = 'none';
                return;
            }

            tbody.innerHTML = appointments.map(a => `
                <tr>
                    <td><strong>${a.fullname}</strong></td>
                    <td>${a.phone}</td>
                    <td>${a.service}</td>
                    <td>${a.branch ? a.branch.charAt(0).toUpperCase() + a.branch.slice(1) : '-'}</td>
                    <td>${formatDate(a.date)}</td>
                    <td>${a.time}</td>
                    <td>${getStatusBadge(a.status)}</td>
                    <td class="actions">
                        <button class="action-view" onclick="viewAppointment('${a.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${a.status === 'pending' ? `
                            <button class="action-confirm" onclick="quickConfirm('${a.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="action-delete" onclick="removeAppointment('${a.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function viewAppointment(id) {
            currentAppointmentId = id;
            const appointments = getAppointments();
            const a = appointments.find(apt => apt.id === id);

            if (!a) return;

            document.getElementById('appointmentDetails').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Full Name</div>
                        <div class="detail-value">${a.fullname}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone Number</div>
                        <div class="detail-value">${a.phone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${a.email || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Date of Birth</div>
                        <div class="detail-value">${formatDate(a.dob)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ID/Passport</div>
                        <div class="detail-value">${a.idNumber || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Service</div>
                        <div class="detail-value">${a.service}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Preferred Branch</div>
                        <div class="detail-value">${a.branch ? a.branch.charAt(0).toUpperCase() + a.branch.slice(1) : '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Appointment Date</div>
                        <div class="detail-value">${formatDate(a.date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Preferred Time</div>
                        <div class="detail-value">${a.time}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">${getStatusBadge(a.status)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Patient Status</div>
                        <div class="detail-value">${a.firstVisit ? '<span class="badge badge-info">New Patient</span>' : '<span class="badge">Returning</span>'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">SMS Reminders</div>
                        <div class="detail-value">${a.smsReminders ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>'}</div>
                    </div>
                    <div class="detail-item full">
                        <div class="detail-label">Reason for Visit</div>
                        <div class="detail-value">${a.reason || 'Not specified'}</div>
                    </div>
                    ${a.insuranceProvider ? `
                    <div class="detail-item">
                        <div class="detail-label">Insurance Provider</div>
                        <div class="detail-value">${a.insuranceProvider}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Policy Number</div>
                        <div class="detail-value">${a.policyNumber || '-'}</div>
                    </div>
                    ` : ''}
                    <div class="detail-item full">
                        <div class="detail-label">Additional Notes</div>
                        <div class="detail-value">${a.notes || 'No additional notes'}</div>
                    </div>
                    <div class="detail-item full">
                        <div class="detail-label">Submitted On</div>
                        <div class="detail-value">${formatDateTime(a.createdAt)}</div>
                    </div>
                </div>
            `;

            // Show/hide confirm button based on status
            document.getElementById('confirmBtn').style.display = a.status === 'pending' ? 'inline-flex' : 'none';

            document.getElementById('viewModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('viewModal').classList.remove('active');
            currentAppointmentId = null;
        }

        function confirmAppointment() {
            if (currentAppointmentId) {
                updateAppointmentStatus(currentAppointmentId, 'confirmed');
                closeModal();
                loadAppointments();
            }
        }

        function quickConfirm(id) {
            if (confirm('Confirm this appointment?')) {
                updateAppointmentStatus(id, 'confirmed');
                loadAppointments();
            }
        }

        function removeAppointment(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                deleteAppointment(id);
                loadAppointments();
            }
        }

        function exportAppointmentsCSV() {
            const data = getAppointments().map(a => ({
                'Patient Name': a.fullname,
                'Phone': a.phone,
                'Email': a.email,
                'DOB': a.dob,
                'ID Number': a.idNumber,
                'Service': a.service,
                'Branch': a.branch,
                'Date': a.date,
                'Time': a.time,
                'Reason': a.reason,
                'First Visit': a.firstVisit ? 'Yes' : 'No',
                'Insurance': a.insuranceProvider || 'N/A',
                'Policy No': a.policyNumber || 'N/A',
                'Status': a.status,
                'Notes': a.notes,
                'Submitted': a.createdAt
            }));
            exportToCSV(data, 'appointments');
        }

        function exportAppointmentsPDF() {
            const data = getAppointments().map(a => ({
                'Patient': a.fullname,
                'Phone': a.phone,
                'Service': a.service,
                'Branch': a.branch || '-',
                'Date': formatDate(a.date),
                'Status': a.status
            }));
            exportToPDF(data, 'Appointment Requests Report', 'appointments');
        }

        function toggleSidebar() {
            document.querySelector('.admin-sidebar').classList.toggle('active');
        }

        // Initialize
        loadAppointments();
    </script>
</body>

</html>