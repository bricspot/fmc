<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Messages | Focus Clinical Admin</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="admin-styles.css">

    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>

<body class="admin-body">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <img src="../assets/images/admin-logo.png" alt="Focus Clinical" class="sidebar-logo">
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </a>
            <a href="appointments.html" class="nav-item">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </a>
            <a href="contacts.html" class="nav-item active">
                <i class="fas fa-envelope"></i>
                <span>Contact Messages</span>
            </a>
            <a href="settings.html" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="../index.html" class="nav-item">
                <i class="fas fa-globe"></i>
                <span>View Website</span>
            </a>
            <button class="nav-item logout-btn" onclick="adminLogout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Contact Messages</h1>
            </div>
            <div class="topbar-right">
                <div class="admin-user">
                    <i class="fas fa-user-circle"></i>
                    <span>helpdesk@focusdiagnostics.co.ke</span>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <!-- Page Header -->
            <div class="page-header">
                <h2>All Contact Inquiries</h2>
                <div class="header-actions">
                    <button class="btn btn-export" onclick="exportContactsCSV()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-export" onclick="exportContactsPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>

            <!-- Contacts Table -->
            <div class="dashboard-card">
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="contactsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Subject</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <p class="empty-state" id="noContacts" style="display: none;">
                        <i class="fas fa-inbox"></i><br>
                        No contact messages found
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- View Modal -->
    <div class="modal-overlay" id="viewModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Message Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="contactDetails">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
                <a href="#" class="btn btn-primary" id="replyBtn">
                    <i class="fas fa-reply"></i> Reply via Email
                </a>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
        requireAuth();

        let currentContactId = null;

        async function loadContacts() {
            const contacts = (await getContacts()).reverse();
            const tbody = document.querySelector('#contactsTable tbody');

            if (contacts.length === 0) {
                document.getElementById('noContacts').style.display = 'block';
                document.getElementById('contactsTable').style.display = 'none';
                return;
            }

            tbody.innerHTML = contacts.map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.email}</td>
                    <td>${c.phone || '-'}</td>
                    <td>${c.subject}</td>
                    <td>${formatDate(c.createdAt)}</td>
                    <td>${getStatusBadge(c.status)}</td>
                    <td class="actions">
                        <button class="action-view" onclick="viewContact('${c.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-delete" onclick="removeContact('${c.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewContact(id) {
            currentContactId = id;
            const contacts = await getContacts();
            const c = contacts.find(contact => contact.id === id);

            if (!c) return;

            // Mark as read if unread
            if (c.status === 'unread') {
                await updateContactStatus(id, 'read');
            }

            document.getElementById('contactDetails').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Full Name</div>
                        <div class="detail-value">${c.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email Address</div>
                        <div class="detail-value">${c.email}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone Number</div>
                        <div class="detail-value">${c.phone || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Subject</div>
                        <div class="detail-value">${c.subject}</div>
                    </div>
                    <div class="detail-item full">
                        <div class="detail-label">Message</div>
                        <div class="detail-value" style="white-space: pre-wrap; line-height: 1.6;">${c.message}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">${getStatusBadge(c.status)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Received On</div>
                        <div class="detail-value">${formatDateTime(c.createdAt)}</div>
                    </div>
                </div>
            `;

            // Set reply email link
            const subject = encodeURIComponent(`Re: ${c.subject}`);
            const body = encodeURIComponent(`Dear ${c.name},\n\nThank you for contacting Focus Clinical and Diagnostics Centre.\n\n---\nOriginal Message:\n${c.message}\n---\n\nBest regards,\nFocus Clinical Team`);
            document.getElementById('replyBtn').href = `mailto:${c.email}?subject=${subject}&body=${body}`;
            document.getElementById('replyBtn').onclick = async function () {
                await updateContactStatus(id, 'replied');
                loadContacts();
            };

            document.getElementById('viewModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('viewModal').classList.remove('active');
            currentContactId = null;
            loadContacts(); // Refresh to show updated status
        }

        async function removeContact(id) {
            if (confirm('Are you sure you want to delete this message?')) {
                await deleteContact(id);
                loadContacts();
            }
        }

        async function exportContactsCSV() {
            const data = (await getContacts()).map(c => ({
                'Name': c.name,
                'Email': c.email,
                'Phone': c.phone,
                'Subject': c.subject,
                'Message': c.message,
                'Status': c.status,
                'Received': c.createdAt
            }));
            exportToCSV(data, 'contact_messages');
        }

        async function exportContactsPDF() {
            const data = (await getContacts()).map(c => ({
                'Name': c.name,
                'Email': c.email,
                'Phone': c.phone || '-',
                'Subject': c.subject,
                'Status': c.status,
                'Date': formatDate(c.createdAt)
            }));
            exportToPDF(data, 'Contact Messages Report', 'contacts');
        }

        function toggleSidebar() {
            document.querySelector('.admin-sidebar').classList.toggle('active');
        }

        // Initialize
        loadContacts();
    </script>
</body>

</html>